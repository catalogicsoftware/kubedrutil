stages:
  - lint
  - build
  - push

.dnd_template:
  image: docker:19.03
  services:
    - name: docker:19.03-dind
      command: ["--insecure-registry=docker-registry.devad.catalogic.us:5000"]
  before_script:
    - apk add --no-cache make
    - docker info
    - cd images
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_REGISTRY: docker-registry.devad.catalogic.us:5000
    DOCKER_OPTS: "--insecure-registry='docker-registry.devad.catalogic.us:5000'"
    DOCKER_DRIVER: overlay2

    DOCKER_KUBEDRUTIL_IMAGE_NAME_SHORT: kubedrutil
    DOCKER_KUBEDRUTIL_IMAGE_NAME_LONG: $DOCKER_REGISTRY/$DOCKER_KUBEDRUTIL_IMAGE_NAME_SHORT
    DOCKER_KUBEDRUTIL_IMAGE_TAG: $CI_COMMIT_SHORT_SHA

yaml_lint:
  stage: lint
  image: sdesbure/yamllint
  script:
    - yamllint .
  only:
    changes:
      - "**/*.yml"
      - "**/*.yaml"

build_image:
  extends: .dnd_template
  stage: build
  script:
    - make build
  only:
    changes:
      - images/**/*

push_latest:
  extends: .dnd_template
  stage: push
  variables:
    GIT_STRATEGY: none
  script:
    - make docker_push_latest
  only:
    refs:
      - master
    changes:
      - images/**/*

push_tag:
  extends: .dnd_template
  stage: push
  variables:
    GIT_STRATEGY: none
  script:
    - make docker_push_tags
  only:
    refs:
      - tags
    changes:
      - images/**/*
