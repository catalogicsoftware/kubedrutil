stages:
  - build
  - push

variables:

.dnd_template:
  image: docker:19.03
  services:
    - name: docker:19.03-dind
      command: ["--insecure-registry=docker-registry.devad.catalogic.us:5000"]
  before_script:
    - docker info
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_REGISTRY: docker-registry.devad.catalogic.us:5000
    DOCKER_OPTS: "--insecure-registry='docker-registry.devad.catalogic.us:5000'"
    DOCKER_DRIVER: overlay2

    DOCKER_IMAGE_NAME_SHORT: kubedrutil
    DOCKER_IMAGE_NAME_FULL:  $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME_SHORT

build_image:
  extends: .dnd_template
  stage: build
  script:
    - docker pull $DOCKER_IMAGE_NAME_FULL:latest || true
    - >
      docker build
      --cache-from $DOCKER_IMAGE_NAME_FULL:latest
      --tag $DOCKER_IMAGE_NAME_FULL:$CI_COMMIT_SHORT_SHA
      .
    - docker push $DOCKER_IMAGE_NAME_FULL:$CI_COMMIT_SHORT_SHA

push_latest:
  extends: .dnd_template
  stage: push
  variables:
    GIT_STRATEGY: none
  script:
    - docker pull $DOCKER_IMAGE_NAME_FULL:$CI_COMMIT_SHORT_SHA || true
    - docker tag $DOCKER_IMAGE_NAME_FULL:$CI_COMMIT_SHORT_SHA $DOCKER_IMAGE_NAME_FULL:latest
    - docker push $DOCKER_IMAGE_NAME_FULL:latest
  only:
    refs:
      - master

push_tag:
  extends: .dnd_template
  stage: push
  variables:
    GIT_STRATEGY: none
  script:
    - docker pull $DOCKER_IMAGE_NAME_FULL:$CI_COMMIT_SHORT_SHA || true
    - docker tag $DOCKER_IMAGE_NAME_FULL:$CI_COMMIT_SHORT_SHA $DOCKER_IMAGE_NAME_FULL:$CI_COMMIT_TAG
    - docker push $DOCKER_IMAGE_NAME_FULL:$CI_COMMIT_TAG
  only:
    refs:
      - tags

